<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
</head>

<body class="bg-white text-gray-900 font-[Poppins]">
  <header class="flex items-center justify-between px-6 py-4 border-b">
    <a href="landing-page.html">
      <div class="flex items-center space-x-2 pl-12">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M13.5 16.875C13.5 17.1717 13.412 17.4617 13.2472 17.7084C13.0824 17.955 12.8481 18.1473 12.574 18.2608C12.2999 18.3744 11.9983 18.4041 11.7074 18.3462C11.4164 18.2883 11.1491 18.1454 10.9393 17.9357C10.7296 17.7259 10.5867 17.4586 10.5288 17.1676C10.4709 16.8767 10.5006 16.5751 10.6142 16.301C10.7277 16.0269 10.92 15.7926 11.1666 15.6278C11.4133 15.463 11.7033 15.375 12 15.375C12.3978 15.375 12.7794 15.533 13.0607 15.8143C13.342 16.0956 13.5 16.4772 13.5 16.875ZM20.25 9.75V14.25C20.25 16.438 19.3808 18.5365 17.8336 20.0836C16.2865 21.6308 14.188 22.5 12 22.5C9.81196 22.5 7.71354 21.6308 6.16637 20.0836C4.61919 18.5365 3.75 16.438 3.75 14.25V6C3.75 5.60218 3.90804 5.22064 4.18934 4.93934C4.47064 4.65804 4.85218 4.5 5.25 4.5C5.64782 4.5 6.02936 4.65804 6.31066 4.93934C6.59196 5.22064 6.75 5.60218 6.75 6V11.25C6.75 11.4489 6.82902 11.6397 6.96967 11.7803C7.11032 11.921 7.30109 12 7.5 12C7.69891 12 7.88968 11.921 8.03033 11.7803C8.17098 11.6397 8.25 11.4489 8.25 11.25V3C8.25 2.60218 8.40804 2.22064 8.68934 1.93934C8.97064 1.65804 9.35218 1.5 9.75 1.5C10.1478 1.5 10.5294 1.65804 10.8107 1.93934C11.092 2.22064 11.25 2.60218 11.25 3V10.5C11.25 10.6989 11.329 10.8897 11.4697 11.0303C11.6103 11.171 11.8011 11.25 12 11.25C12.1989 11.25 12.3897 11.171 12.5303 11.0303C12.671 10.8897 12.75 10.6989 12.75 10.5V4.5C12.75 4.10218 12.908 3.72064 13.1893 3.43934C13.4706 3.15804 13.8522 3 14.25 3C14.6478 3 15.0294 3.15804 15.3107 3.43934C15.592 3.72064 15.75 4.10218 15.75 4.5V12C15.75 12.1989 15.829 12.3897 15.9697 12.5303C16.1103 12.671 16.3011 12.75 16.5 12.75C16.6989 12.75 16.8897 12.671 17.0303 12.5303C17.171 12.3897 17.25 12.1989 17.25 12V9.75C17.25 9.35218 17.408 8.97064 17.6893 8.68934C17.9706 8.40804 18.3522 8.25 18.75 8.25C19.1478 8.25 19.5294 8.40804 19.8107 8.68934C20.092 8.97064 20.25 9.35218 20.25 9.75ZM16.8356 16.7072C16.77 16.5759 15.195 13.5 12 13.5C8.805 13.5 7.23 16.5759 7.16437 16.7072C7.1383 16.7593 7.12473 16.8167 7.12473 16.875C7.12473 16.9333 7.1383 16.9907 7.16437 17.0428C7.23 17.1741 8.805 20.25 12 20.25C15.195 20.25 16.77 17.1741 16.8356 17.0428C16.8617 16.9907 16.8753 16.9333 16.8753 16.875C16.8753 16.8167 16.8617 16.7593 16.8356 16.7072Z"
            fill="#FF4000" />
        </svg>
        <span class="font-semibold text-lg">RedSeam Clothing</span>
      </div>
    </a>
    <div id="headerAction" class="pr-12"></div>
  </header>

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40"></div>

  <div id="loginPopup" class="fixed inset-0 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-8 shadow-lg w-96">
      <h2 class="text-xl font-semibold mb-4">Log in required</h2>
      <p class="mb-6 text-gray-600">Please log in to add items to your cart.</p>
      <div class="flex justify-end gap-3">
        <button id="closePopup" class="px-4 py-2 border rounded">Cancel</button>
        <a href="/login.html" class="px-4 py-2 bg-orange-600 text-white rounded">Log in</a>
      </div>
    </div>
  </div>

  <div class="container mx-auto p-6">
    <nav class="text-sm text-gray-500 mb-4">Listing / Product</nav>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div class="flex gap-4">
        <div id="thumbnails" class="flex flex-col gap-3 w-24"></div>
        <div class="flex-1">
          <img id="mainImage" src="" alt="Product" class="rounded-lg w-full object-cover" />
        </div>
      </div>

      <div>
        <h1 id="productName" class="text-2xl font-semibold mb-2"></h1>
        <p id="productPrice" class="text-xl font-bold mb-4"></p>

        <div id="colorSection" class="mb-4 hidden">
          <p class="text-sm font-medium text-gray-700">Color: <span id="selectedColor"></span></p>
          <div id="colorOptions" class="flex gap-3 mt-2"></div>
        </div>

        <div id="sizeSection" class="mb-4 hidden">
          <p class="text-sm font-medium text-gray-700">Size: <span id="selectedSize"></span></p>
          <div id="sizeOptions" class="flex gap-2 mt-2"></div>
        </div>

        <div class="mb-6">
          <p class="text-sm font-medium text-gray-700">Quantity</p>
          <select id="quantitySelect" class="mt-1 border rounded-md px-3 py-2"></select>
        </div>

        <button id="addToCartBtn"
          class="bg-orange-600 text-white w-full py-3 rounded-md hover:bg-orange-700 flex items-center justify-center gap-2">
          <svg width="22" height="21" viewBox="0 0 22 21" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M1.25 1.5H2.63568C3.14537 1.5 3.59138 1.84265 3.7227 2.33513L4.1059 3.77209M6.5 12.75C4.84315 12.75 3.5 14.0931 3.5 15.75H19.25M6.5 12.75H17.7183C18.8394 10.4494 19.8177 8.06635 20.6417 5.6125C15.88 4.39646 10.8905 3.75 5.75 3.75C5.20021 3.75 4.65214 3.7574 4.1059 3.77209M6.5 12.75L4.1059 3.77209M5 18.75C5 19.1642 4.66421 19.5 4.25 19.5C3.83579 19.5 3.5 19.1642 3.5 18.75C3.5 18.3358 3.83579 18 4.25 18C4.66421 18 5 18.3358 5 18.75ZM17.75 18.75C17.75 19.1642 17.4142 19.5 17 19.5C16.5858 19.5 16.25 19.1642 16.25 18.75C16.25 18.3358 16.5858 18 17 18C17.4142 18 17.75 18.3358 17.75 18.75Z"
              stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
          Add to cart
        </button>

        <div class="mt-8 border-t pt-6">
          <h2 class="font-semibold mb-2">Details</h2>
          <p id="productBrand" class="text-sm text-gray-700 flex items-center gap-2"></p>
          <p id="productDescription" class="text-sm text-gray-500 mt-2"></p>
        </div>
      </div>
    </div>
  </div>

  <div id="cartSidebar"
    class="fixed top-0 right-0 w-96 h-full bg-white shadow-lg transform translate-x-full transition-transform z-50 flex flex-col">
    <div class="flex items-center justify-between p-4 border-b">
      <h2 class="text-lg font-semibold">Your Cart</h2>
      <button id="closeCartBtn" class="text-gray-500 hover:text-black">âœ–</button>
    </div>
    <div id="cartItems" class="flex-1 overflow-y-auto p-4"></div>
    <div class="border-t p-4">
      <div class="flex justify-between text-sm mb-2">
        <span>Subtotal</span><span id="subtotal">$0</span>
      </div>
      <div class="flex justify-between text-sm mb-2">
        <span>Delivery</span><span id="delivery">$5</span>
      </div>
      <div class="flex justify-between font-semibold mb-4">
        <span>Total</span><span id="total">$0</span>
      </div>
      <a href="checkout.html"
        class="block w-full text-center bg-orange-600 text-white py-3 rounded hover:bg-orange-700">
        Go to Checkout
      </a>
    </div>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get("id"); 
    const apiUrl = `https://api.redseam.redberryinternship.ge/api/products/${productId}`;
    const cartApi = "https://api.redseam.redberryinternship.ge/api/cart/products/";
    const colorMap = {
      "Yellow": "#FFD700",
      "Green": "#008000",
      "Red": "#FF0000",
      "Blue": "#0000FF",
      "Black": "#000000",
      "White": "#FFFFFF"
    };

    const overlay = document.getElementById("overlay");
    const sidebar = document.getElementById("cartSidebar");
    const headerAction = document.getElementById("headerAction");

    function renderHeader() {
      const token = localStorage.getItem("token");
      const storedUser = localStorage.getItem("user");

      if (storedUser && token) {
        const user = JSON.parse(storedUser);
        const avatarUrl = user.avatar 
        ? user.avatar 
        : "https://via.placeholder.com/40";

        headerAction.innerHTML = `
          <button id="openCartBtn" class="flex items-center text-xl font-medium text-gray-800 hover:text-black">
          <div class="flex items-center space-x-2">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.25 2.25C1.83579 2.25 1.5 2.58579 1.5 3C1.5 3.41421 1.83579 3.75 2.25 3.75H3.63568C3.80558 3.75 3.95425 3.86422 3.99803 4.02838L6.55576 13.6199C4.94178 14.0385 3.75 15.5051 3.75 17.25C3.75 17.6642 4.08579 18 4.5 18H20.25C20.6642 18 21 17.6642 21 17.25C21 16.8358 20.6642 16.5 20.25 16.5H5.37803C5.68691 15.6261 6.52034 15 7.5 15H18.7183C19.0051 15 19.2668 14.8364 19.3925 14.5785C20.5277 12.249 21.5183 9.83603 22.3527 7.35126C22.4191 7.15357 22.4002 6.93716 22.3005 6.75399C22.2008 6.57082 22.0294 6.43743 21.8273 6.38583C17.0055 5.15442 11.9536 4.5 6.75 4.5C6.39217 4.5 6.03505 4.5031 5.67868 4.50926L5.44738 3.64188C5.2285 2.82109 4.48515 2.25 3.63568 2.25H2.25Z" fill="#10151F"/>
            <path d="M3.75 20.25C3.75 19.4216 4.42157 18.75 5.25 18.75C6.07843 18.75 6.75 19.4216 6.75 20.25C6.75 21.0784 6.07843 21.75 5.25 21.75C4.42157 21.75 3.75 21.0784 3.75 20.25Z" fill="#10151F"/>
            <path d="M16.5 20.25C16.5 19.4216 17.1716 18.75 18 18.75C18.8284 18.75 19.5 19.4216 19.5 20.25C19.5 21.0784 18.8284 21.75 18 21.75C17.1716 21.75 16.5 21.0784 16.5 20.25Z" fill="#10151F"/>
            </svg>
            <img src="${avatarUrl}" alt="avatar" class="w-10 h-10 rounded-full object-cover border" />
            <span class="font-medium"><svg width="10" height="7" viewBox="0 0 10 7" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M0.21967 0.71967C0.512563 0.426777 0.987437 0.426777 1.28033 0.71967L5 4.43934L8.71967 0.719671C9.01256 0.426777 9.48744 0.426777 9.78033 0.719671C10.0732 1.01256 10.0732 1.48744 9.78033 1.78033L5.53033 6.03033C5.38968 6.17098 5.19891 6.25 5 6.25C4.80109 6.25 4.61032 6.17098 4.46967 6.03033L0.21967 1.78033C-0.0732233 1.48744 -0.0732233 1.01256 0.21967 0.71967Z" fill="#10151F"/>
            </svg>
            </span>
          </div>
          </button>
        `;
        document.getElementById("openCartBtn").onclick = () => {
          sidebar.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        };
      } else {
        headerAction.innerHTML = `
          <a href="#" id="loginBtn" class="flex items-center text-xl font-medium text-gray-800 hover:text-black">
            <svg width="14" height="16" viewBox="0 0 14 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M7 6C8.65685 6 10 4.65685 10 3C10 1.34315 8.65685 0 7 0C5.34315 0 4 1.34315 4 3C4 4.65685 5.34315 6 7 6Z" fill="#10151F"/>
              <path d="M0.465171 12.4935C0.270287 13.0016 0.444349 13.571 0.874199 13.9046C2.56656 15.218 4.69202 16 7.00012 16C9.31057 16 11.438 15.2164 13.1312 13.9006C13.5608 13.5667 13.7345 12.9971 13.5393 12.4892C12.5301 9.86354 9.98419 8 7.00307 8C4.02032 8 1.47329 9.86557 0.465171 12.4935Z" fill="#10151F"/>
            </svg>
            Log in
          </a>
        `;
        document.getElementById("loginBtn").onclick = () => {
          document.getElementById("loginPopup").classList.remove("hidden");
          overlay.classList.remove("hidden");
        };
      }
    }

    document.getElementById("closeCartBtn").onclick = () => {
      sidebar.classList.add("translate-x-full");
      overlay.classList.add("hidden");
    };

    async function loadProduct() {
      try {
        const res = await fetch(apiUrl);
        const product = await res.json();

        document.getElementById("productName").textContent = product.name;
        document.getElementById("productPrice").textContent = `$ ${product.price}`;
        document.getElementById("productDescription").textContent = product.description;
        document.getElementById("productBrand").innerHTML = `
          <img src="${product.brand.image}" class="w-12 h-12 object-contain"/> 
          <span>Brand: ${product.brand.name}</span>
        `;
        document.getElementById("mainImage").src = product.cover_image;

        const thumbnails = document.getElementById("thumbnails");
        (product.images?.length ? product.images : [product.cover_image]).forEach(img => {
          const thumb = document.createElement("img");
          thumb.src = img;
          thumb.className = "w-20 h-20 object-cover rounded cursor-pointer border hover:border-gray-500";
          thumb.onclick = () => { document.getElementById("mainImage").src = img; };
          thumbnails.appendChild(thumb);
        });

        if (product.available_colors?.length) {
          const colorOptions = document.getElementById("colorOptions");
          document.getElementById("colorSection").classList.remove("hidden");
          product.available_colors.forEach((color, idx) => {
            const circle = document.createElement("div");
            circle.className = "w-8 h-8 rounded-full border-2 cursor-pointer";
            circle.style.backgroundColor = colorMap[color] || color;
            if (idx === 0) {
              circle.classList.add("border-red-500");
              document.getElementById("selectedColor").textContent = color;
            } else circle.classList.add("border-gray-300");

            circle.onclick = () => {
              document.querySelectorAll("#colorOptions div").forEach(c => 
                c.classList.replace("border-red-500","border-gray-300")
              );
              circle.classList.replace("border-gray-300","border-red-500");
              document.getElementById("selectedColor").textContent = color;

              if (product.images?.[idx]) {
                const mainImage = document.getElementById("mainImage");
                mainImage.src = product.images[idx];

                const thumbnails = document.querySelectorAll("#thumbnails img");
                thumbnails.forEach((thumb, tIdx) => {
                  thumb.classList.remove("ring-2","ring-red-500");
                  if (tIdx === idx) {
                    thumb.classList.add("ring-2","ring-red-500");
                  }
                });
              }
            };

            colorOptions.appendChild(circle);
          });
        }

        if (product.available_sizes?.length) {
          const sizeOptions = document.getElementById("sizeOptions");
          document.getElementById("sizeSection").classList.remove("hidden");
          product.available_sizes.forEach((size, idx) => {
            const btn = document.createElement("button");
            btn.textContent = size;
            btn.className = "px-3 py-1 border rounded cursor-pointer";
            if (idx === 0) {
              btn.classList.add("border-red-500");
              document.getElementById("selectedSize").textContent = size;
            } else btn.classList.add("border-gray-300");
            btn.onclick = () => {
              document.querySelectorAll("#sizeOptions button").forEach(b => b.classList.replace("border-red-500","border-gray-300"));
              btn.classList.replace("border-gray-300","border-red-500");
              document.getElementById("selectedSize").textContent = size;
            };
            sizeOptions.appendChild(btn);
          });
        }

        const qtySelect = document.getElementById("quantitySelect");
        for (let i=1;i<=product.quantity;i++){
          const opt=document.createElement("option");
          opt.value=i; opt.textContent=i;
          qtySelect.appendChild(opt);
        }

        document.getElementById("addToCartBtn").onclick = async () => {
          const loggedIn = localStorage.getItem("token");
          if (!loggedIn) {
            document.getElementById("loginPopup").classList.remove("hidden");
            overlay.classList.remove("hidden");
            return;
          }

          const qty = parseInt(qtySelect.value);
          const size = document.getElementById("selectedSize").textContent;
          const color = document.getElementById("selectedColor").textContent;

          await fetch(cartApi + product.id, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${loggedIn}`
            },
            body: JSON.stringify({
              id: product.id,
              quantity: qty,
              size,
              color
            })
          });

          loadCart();
          sidebar.classList.remove("translate-x-full");
          overlay.classList.remove("hidden");
        };

      } catch (err) { console.error(err); }
    }

    async function loadCart(){
      const token = localStorage.getItem("token");
      if (!token) return;
      const res = await fetch("https://api.redseam.redberryinternship.ge/api/cart", {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const cart = await res.json();
      const cartItems=document.getElementById("cartItems");
      cartItems.innerHTML="";
      let subtotal=0;
      let count=0;
      cart.forEach(item=>{
        subtotal += item.total_price;
        count += item.quantity;
        const div=document.createElement("div");
        div.className="flex items-center gap-3 mb-4";
        div.innerHTML=`
          <img src="${item.cover_image}" class="w-16 h-16 object-cover rounded"/>
          <div>
            <p class="font-medium">${item.name}</p>
            <p class="text-sm text-gray-500">Qty: ${item.quantity}</p>
            <p class="text-sm">$${item.total_price}</p>
          </div>`;
        cartItems.appendChild(div);
      });
      document.getElementById("subtotal").textContent="$"+subtotal.toFixed(2);
      const delivery=5;
      document.getElementById("total").textContent="$"+(subtotal+delivery).toFixed(2);

      const cartCount = document.getElementById("cartCount");
      if (cartCount) cartCount.textContent = count;
    }

    loadProduct();
    renderHeader();
    loadCart();

    document.getElementById("closePopup").onclick = () => {
      document.getElementById("loginPopup").classList.add("hidden");
      overlay.classList.add("hidden");
    };
</script>

</body>
</html>
